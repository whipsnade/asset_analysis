import{_ as xe,y as ke,c as g,b as l,w as s,r as u,h as y,o as p,f as i,a as t,t as a,i as w,F as H,s as J,l as T,k as Y,z as K,A as be,B as we,C as Ve,E as C,g as Q,D as j,G as he}from"./index-XRkGQpRf.js";import{a as Ce,b as Ue,c as De,e as ze,d as Fe}from"./procurement-CG3z4prW.js";const Se={class:"procurement-page"},Ee={class:"card-header"},Ie={key:0,class:"text-input"},Le={key:1,class:"file-input"},Re={class:"card-header"},Te={class:"header-actions"},Ye={key:1,class:"result-list"},je={class:"result-header"},qe={class:"result-index"},Ae={class:"result-section"},Me={class:"section-body"},Oe={class:"result-section matched"},Be={key:0,class:"section-body"},Ne={key:1,class:"section-body no-match"},$e={key:0,class:"match-reason"},Pe={style:{display:"flex","align-items":"center",width:"100%"}},Ge={style:{width:"50px","text-align":"right"}},He={class:"export-filter-info"},Je={class:"progress-content"},Ke={class:"progress-status"},Qe={class:"status-text"},We={class:"progress-log-panel"},Xe={class:"progress-log-header"},Ze={class:"log-count"},el={class:"log-time"},ll={class:"log-level"},tl={class:"log-msg"},sl={key:0,class:"log-line log-info"},ol={__name:"index",setup(nl){const q=y("text"),D=y(""),x=y([]),f=y(!1),W=y(null),z=y(!1),A=y(!1),F=y(!1),I=y(null),V=y([]),k=y(0);let U=null,S=null;const n=Q({task_id:null,status:"",message:"",details:[]}),c=Q({customer_abbr:"",project_name:"",invoice_title:"",requester:"",order_date:"",delivery_address:"",min_confidence:0}),X=j(()=>{var e;if(!((e=n.details)!=null&&e.length))return 0;const r=c.min_confidence/100;return n.details.filter(_=>(_.confidence_score||0)>=r).length}),Z=j(()=>n.status==="completed"?"success":n.status==="failed"?"danger":"info"),ee=j(()=>f.value?"":n.status==="completed"?"success":n.status==="failed"?"exception":""),le=j(()=>{var r;return f.value?"正在使用 DeepSeek AI 分析采购需求...":n.status==="completed"?`分析完成，共匹配 ${((r=n.details)==null?void 0:r.length)||0} 条需求`:n.status==="failed"?"分析失败，请重试":"准备中..."}),te=r=>r?r>=.8?"success":r>=.5?"warning":"danger":"info",se=(r,e)=>{x.value=e.map(_=>_.raw)},oe=(r,e)=>{x.value=e.map(_=>_.raw)},ne=()=>"sess_"+Date.now()+"_"+Math.random().toString(36).substr(2,9),O=()=>{S=ne(),V.value=[];const r=Fe(S);U=new EventSource(r),U.onmessage=e=>{try{const _=JSON.parse(e.data);if(_.type==="heartbeat")return;V.value.push(_),he(()=>{I.value&&(I.value.scrollTop=I.value.scrollHeight)})}catch(_){console.error("Failed to parse log:",_)}},U.onerror=()=>{L()}},L=()=>{U&&(U.close(),U=null)},ae=async()=>{if(!D.value.trim()){C.warning("请输入采购需求内容");return}V.value=[],k.value=10,F.value=!0,f.value=!0,O();try{k.value=30;const r=await Ce(D.value,S);Object.assign(n,r),k.value=100,C.success("分析完成")}catch{n.status="failed",n.message="分析失败",n.details=[],k.value=100}finally{f.value=!1,L()}},re=async()=>{if(x.value.length===0){C.warning("请选择要上传的文件");return}V.value=[],k.value=10,F.value=!0,f.value=!0,O();try{k.value=30;const r=x.value.length===1?await Ue(x.value[0],S):await De(x.value,S);Object.assign(n,r),k.value=100,C.success("分析完成")}catch{n.status="failed",n.message="分析失败",n.details=[],k.value=100}finally{f.value=!1,L()}},de=()=>{z.value=!0},ue=async()=>{const r=c.min_confidence/100,e=n.details.filter(_=>(_.confidence_score||0)>=r);if(e.length===0){C.warning("没有符合匹配度条件的数据可导出");return}A.value=!0;try{const _={...c,details:e.map(v=>({parsed_name:v.parsed_name||"",parsed_spec:v.parsed_spec||"",parsed_quantity:v.parsed_quantity||"",matched_inventory:v.matched_inventory||null,remark:"",purchase_link:""}))},M=await ze(_),b=new Blob([M],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),E=window.URL.createObjectURL(b),m=document.createElement("a");m.href=E,m.download=`采购清单_${new Date().toISOString().slice(0,10)}.xlsx`,document.body.appendChild(m),m.click(),document.body.removeChild(m),window.URL.revokeObjectURL(E),C.success("导出成功"),z.value=!1}catch{C.error("导出失败")}finally{A.value=!1}};return ke(()=>{L()}),(r,e)=>{const _=u("el-radio-button"),M=u("el-radio-group"),b=u("el-input"),E=u("DataAnalysis"),m=u("el-icon"),v=u("el-button"),ie=u("UploadFilled"),pe=u("el-upload"),B=u("el-card"),R=u("el-col"),N=u("el-tag"),$=u("Download"),ce=u("el-empty"),P=u("el-row"),_e=u("InfoFilled"),h=u("el-form-item"),me=u("el-date-picker"),fe=u("el-slider"),ve=u("el-form"),G=u("el-dialog"),ge=u("el-progress");return p(),g("div",Se,[l(P,{gutter:20},{default:s(()=>[l(R,{span:10},{default:s(()=>[l(B,{class:"input-card"},{header:s(()=>[t("div",Ee,[e[15]||(e[15]=t("span",null,"采购需求输入",-1)),l(M,{modelValue:q.value,"onUpdate:modelValue":e[0]||(e[0]=o=>q.value=o),size:"small"},{default:s(()=>[l(_,{value:"text"},{default:s(()=>[...e[13]||(e[13]=[i("文本输入",-1)])]),_:1}),l(_,{value:"file"},{default:s(()=>[...e[14]||(e[14]=[i("文件上传",-1)])]),_:1})]),_:1},8,["modelValue"])])]),default:s(()=>[q.value==="text"?(p(),g("div",Ie,[l(b,{modelValue:D.value,"onUpdate:modelValue":e[1]||(e[1]=o=>D.value=o),type:"textarea",rows:10,placeholder:`请粘贴客户的采购需求内容，例如：
1. 32寸叫号屏 2台
2. POE交换机16口 1个
3. 监控摄像头200万像素 10个`},null,8,["modelValue"]),l(v,{type:"primary",loading:f.value,disabled:!D.value.trim(),style:{"margin-top":"15px",width:"100%"},onClick:ae},{default:s(()=>[l(m,null,{default:s(()=>[l(E)]),_:1}),e[16]||(e[16]=i(" 开始智能分析 ",-1))]),_:1},8,["loading","disabled"])])):(p(),g("div",Le,[l(pe,{ref_key:"uploadRef",ref:W,drag:"",multiple:"","auto-upload":!1,"on-change":se,"on-remove":oe,accept:".xlsx,.xls"},{tip:s(()=>[...e[17]||(e[17]=[t("div",{class:"el-upload__tip"}," 支持 .xlsx, .xls 格式，可同时上传多个文件 ",-1)])]),default:s(()=>[l(m,{size:"48",color:"#409EFF"},{default:s(()=>[l(ie)]),_:1}),e[18]||(e[18]=t("div",{class:"el-upload__text"},[i(" 拖拽Excel文件到此处，或"),t("em",null,"点击上传")],-1))]),_:1},512),l(v,{type:"primary",loading:f.value,disabled:x.value.length===0,style:{"margin-top":"15px",width:"100%"},onClick:re},{default:s(()=>[l(m,null,{default:s(()=>[l(E)]),_:1}),i(" 开始智能分析"+a(x.value.length>0?` (${x.value.length}个文件)`:""),1)]),_:1},8,["loading","disabled"])]))]),_:1})]),_:1}),l(R,{span:14},{default:s(()=>[l(B,{class:"result-card"},{header:s(()=>{var o;return[t("div",Re,[e[20]||(e[20]=t("span",null,"匹配结果",-1)),t("div",Te,[n.status?(p(),w(N,{key:0,type:Z.value,style:{"margin-right":"10px"}},{default:s(()=>[i(a(n.message),1)]),_:1},8,["type"])):T("",!0),(o=n.details)!=null&&o.length?(p(),w(v,{key:1,type:"success",size:"small",onClick:de},{default:s(()=>[l(m,null,{default:s(()=>[l($)]),_:1}),e[19]||(e[19]=i(" 导出Excel ",-1))]),_:1})):T("",!0)])])]}),default:s(()=>{var o;return[(o=n.details)!=null&&o.length?(p(),g("div",Ye,[(p(!0),g(H,null,J(n.details,(d,ye)=>(p(),g("div",{key:d.id,class:"result-item"},[t("div",je,[t("span",qe,a(ye+1),1),l(N,{type:te(d.confidence_score),size:"small"},{default:s(()=>[i(" 匹配度: "+a(Math.round((d.confidence_score||0)*100))+"% ",1)]),_:2},1032,["type"])]),l(P,{gutter:15,class:"result-content"},{default:s(()=>[l(R,{span:12},{default:s(()=>[t("div",Ae,[e[24]||(e[24]=t("div",{class:"section-title"},"客户需求",-1)),t("div",Me,[t("p",null,[e[21]||(e[21]=t("strong",null,"产品名称:",-1)),i(" "+a(d.parsed_name||"-"),1)]),t("p",null,[e[22]||(e[22]=t("strong",null,"规格型号:",-1)),i(" "+a(d.parsed_spec||"-"),1)]),t("p",null,[e[23]||(e[23]=t("strong",null,"采购数量:",-1)),i(" "+a(d.parsed_quantity||"-"),1)])])])]),_:2},1024),l(R,{span:12},{default:s(()=>[t("div",Oe,[e[31]||(e[31]=t("div",{class:"section-title"},"匹配库存",-1)),d.matched_inventory?(p(),g("div",Be,[t("p",null,[e[25]||(e[25]=t("strong",null,"产品名称:",-1)),i(" "+a(d.matched_inventory.product_name),1)]),t("p",null,[e[26]||(e[26]=t("strong",null,"规格型号:",-1)),i(" "+a(d.matched_inventory.spec||"-"),1)]),t("p",null,[e[27]||(e[27]=t("strong",null,"库存数量:",-1)),i(" "+a(d.matched_inventory.quantity)+" "+a(d.matched_inventory.unit),1)]),t("p",null,[e[28]||(e[28]=t("strong",null,"销售单价:",-1)),i(" "+a(d.matched_inventory.sale_price||"-"),1)]),t("p",null,[e[29]||(e[29]=t("strong",null,"供应商:",-1)),i(" "+a(d.matched_inventory.supplier||"-"),1)])])):(p(),g("div",Ne,[...e[30]||(e[30]=[t("p",null,"未找到匹配的库存项",-1)])]))])]),_:2},1024)]),_:2},1024),d.match_reason?(p(),g("div",$e,[l(m,null,{default:s(()=>[l(_e)]),_:1}),i(" "+a(d.match_reason),1)])):T("",!0)]))),128))])):(p(),w(ce,{key:0,description:"暂无分析结果，请输入采购需求后点击分析"}))]}),_:1})]),_:1})]),_:1}),l(G,{modelValue:z.value,"onUpdate:modelValue":e[10]||(e[10]=o=>z.value=o),title:"导出采购清单",width:"600px"},{footer:s(()=>[l(v,{onClick:e[9]||(e[9]=o=>z.value=!1)},{default:s(()=>[...e[32]||(e[32]=[i("取消",-1)])]),_:1}),l(v,{type:"primary",loading:A.value,onClick:ue},{default:s(()=>[l(m,null,{default:s(()=>[l($)]),_:1}),e[33]||(e[33]=i(" 确认导出 ",-1))]),_:1},8,["loading"])]),default:s(()=>[l(ve,{model:c,"label-width":"120px"},{default:s(()=>[l(h,{label:"客户名称缩写"},{default:s(()=>[l(b,{modelValue:c.customer_abbr,"onUpdate:modelValue":e[2]||(e[2]=o=>c.customer_abbr=o),placeholder:"请输入客户名称缩写"},null,8,["modelValue"])]),_:1}),l(h,{label:"项目/门店名称"},{default:s(()=>[l(b,{modelValue:c.project_name,"onUpdate:modelValue":e[3]||(e[3]=o=>c.project_name=o),placeholder:"请输入项目或门店名称"},null,8,["modelValue"])]),_:1}),l(h,{label:"我方开票抬头"},{default:s(()=>[l(b,{modelValue:c.invoice_title,"onUpdate:modelValue":e[4]||(e[4]=o=>c.invoice_title=o),placeholder:"请输入我方开票抬头"},null,8,["modelValue"])]),_:1}),l(h,{label:"需求发起人"},{default:s(()=>[l(b,{modelValue:c.requester,"onUpdate:modelValue":e[5]||(e[5]=o=>c.requester=o),placeholder:"请输入需求发起人"},null,8,["modelValue"])]),_:1}),l(h,{label:"采购应下单日期"},{default:s(()=>[l(me,{modelValue:c.order_date,"onUpdate:modelValue":e[6]||(e[6]=o=>c.order_date=o),type:"date",placeholder:"选择日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",style:{width:"100%"}},null,8,["modelValue"])]),_:1}),l(h,{label:"收货地址"},{default:s(()=>[l(b,{modelValue:c.delivery_address,"onUpdate:modelValue":e[7]||(e[7]=o=>c.delivery_address=o),type:"textarea",rows:2,placeholder:"请输入收货地址"},null,8,["modelValue"])]),_:1}),l(h,{label:"最低匹配度"},{default:s(()=>{var o;return[t("div",Pe,[l(fe,{modelValue:c.min_confidence,"onUpdate:modelValue":e[8]||(e[8]=d=>c.min_confidence=d),min:0,max:100,step:5,"format-tooltip":d=>d+"%",style:{flex:"1","margin-right":"15px"}},null,8,["modelValue","format-tooltip"]),t("span",Ge,a(c.min_confidence)+"%",1)]),t("div",He," 符合条件: "+a(X.value)+" / "+a(((o=n.details)==null?void 0:o.length)||0)+" 条 ",1)]}),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),l(G,{modelValue:F.value,"onUpdate:modelValue":e[12]||(e[12]=o=>F.value=o),title:"AI智能分析中",width:"650px","close-on-click-modal":!1,"close-on-press-escape":!1,"show-close":!f.value},{footer:s(()=>[f.value?(p(),w(v,{key:1,disabled:""},{default:s(()=>[l(m,{class:"is-loading"},{default:s(()=>[l(Y(K))]),_:1}),e[37]||(e[37]=i(" 分析中... ",-1))]),_:1})):(p(),w(v,{key:0,type:"primary",onClick:e[11]||(e[11]=o=>F.value=!1)},{default:s(()=>[...e[36]||(e[36]=[i(" 确定 ",-1)])]),_:1}))]),default:s(()=>[t("div",Je,[t("div",Ke,[f.value?(p(),w(m,{key:0,class:"is-loading",size:20},{default:s(()=>[l(Y(K))]),_:1})):n.status==="completed"?(p(),w(m,{key:1,size:20,color:"#67c23a"},{default:s(()=>[l(Y(be))]),_:1})):(p(),w(m,{key:2,size:20,color:"#f56c6c"},{default:s(()=>[l(Y(we))]),_:1})),t("span",Qe,a(le.value),1)]),l(ge,{percentage:k.value,status:ee.value,"stroke-width":12,style:{margin:"15px 0"}},null,8,["percentage","status"]),t("div",We,[t("div",Xe,[e[34]||(e[34]=t("span",null,"DeepSeek API 调用日志",-1)),t("span",Ze,a(V.value.length)+" 条",1)]),t("div",{class:"progress-log-content",ref_key:"logContainer",ref:I},[(p(!0),g(H,null,J(V.value,(o,d)=>(p(),g("div",{key:d,class:Ve(["log-line","log-"+o.level.toLowerCase()])},[t("span",el,a(o.time),1),t("span",ll,"["+a(o.level)+"]",1),t("span",tl,a(o.message),1)],2))),128)),f.value&&V.value.length===0?(p(),g("div",sl,[...e[35]||(e[35]=[t("span",{class:"log-msg"},"正在连接AI服务...",-1)])])):T("",!0)],512)])])]),_:1},8,["modelValue","show-close"])])}}},dl=xe(ol,[["__scopeId","data-v-54d786d6"]]);export{dl as default};
