import{_ as ye,y as xe,c as g,b as l,w as s,r as d,h as y,o as p,f as u,a as t,i as b,F as H,s as J,t as i,l as R,k as Y,z as K,A as ke,B as be,C as Ve,E as h,g as Q,D as j,G as we}from"./index-Cvmun6XD.js";import{a as he,b as Ce,e as Ue,c as De}from"./procurement-BCn9Ym0D.js";const ze={class:"procurement-page"},Se={class:"card-header"},Fe={key:0,class:"text-input"},Ee={key:1,class:"file-input"},Ie={class:"card-header"},Le={class:"header-actions"},Te={key:1,class:"result-list"},Re={class:"result-header"},Ye={class:"result-index"},je={class:"result-section"},qe={class:"section-body"},Ae={class:"result-section matched"},Me={key:0,class:"section-body"},Oe={key:1,class:"section-body no-match"},Be={key:0,class:"match-reason"},Ne={style:{display:"flex","align-items":"center",width:"100%"}},$e={style:{width:"50px","text-align":"right"}},Pe={class:"export-filter-info"},Ge={class:"progress-content"},He={class:"progress-status"},Je={class:"status-text"},Ke={class:"progress-log-panel"},Qe={class:"progress-log-header"},We={class:"log-count"},Xe={class:"log-time"},Ze={class:"log-level"},el={class:"log-msg"},ll={key:0,class:"log-line log-info"},tl={__name:"index",setup(sl){const q=y("text"),U=y(""),D=y(null),f=y(!1),W=y(null),z=y(!1),A=y(!1),S=y(!1),E=y(null),V=y([]),x=y(0);let C=null,I=null;const n=Q({task_id:null,status:"",message:"",details:[]}),c=Q({customer_abbr:"",project_name:"",invoice_title:"",requester:"",order_date:"",delivery_address:"",min_confidence:0}),X=j(()=>{var e;if(!((e=n.details)!=null&&e.length))return 0;const a=c.min_confidence/100;return n.details.filter(m=>(m.confidence_score||0)>=a).length}),Z=j(()=>n.status==="completed"?"success":n.status==="failed"?"danger":"info"),ee=j(()=>f.value?"":n.status==="completed"?"success":n.status==="failed"?"exception":""),le=j(()=>{var a;return f.value?"正在使用 DeepSeek AI 分析采购需求...":n.status==="completed"?`分析完成，共匹配 ${((a=n.details)==null?void 0:a.length)||0} 条需求`:n.status==="failed"?"分析失败，请重试":"准备中..."}),te=a=>a?a>=.8?"success":a>=.5?"warning":"danger":"info",se=a=>{D.value=a.raw},oe=()=>"sess_"+Date.now()+"_"+Math.random().toString(36).substr(2,9),O=()=>{I=oe(),V.value=[];const a=De(I);C=new EventSource(a),C.onmessage=e=>{try{const m=JSON.parse(e.data);if(m.type==="heartbeat")return;V.value.push(m),we(()=>{E.value&&(E.value.scrollTop=E.value.scrollHeight)})}catch(m){console.error("Failed to parse log:",m)}},C.onerror=()=>{L()}},L=()=>{C&&(C.close(),C=null)},ne=async()=>{if(!U.value.trim()){h.warning("请输入采购需求内容");return}V.value=[],x.value=10,S.value=!0,f.value=!0,O();try{x.value=30;const a=await he(U.value,I);Object.assign(n,a),x.value=100,h.success("分析完成")}catch{n.status="failed",n.message="分析失败",n.details=[],x.value=100}finally{f.value=!1,L()}},ae=async()=>{if(!D.value){h.warning("请选择要上传的文件");return}V.value=[],x.value=10,S.value=!0,f.value=!0,O();try{x.value=30;const a=await Ce(D.value,I);Object.assign(n,a),x.value=100,h.success("分析完成")}catch{n.status="failed",n.message="分析失败",n.details=[],x.value=100}finally{f.value=!1,L()}},re=()=>{z.value=!0},de=async()=>{const a=c.min_confidence/100,e=n.details.filter(m=>(m.confidence_score||0)>=a);if(e.length===0){h.warning("没有符合匹配度条件的数据可导出");return}A.value=!0;try{const m={...c,details:e.map(v=>({parsed_name:v.parsed_name||"",parsed_spec:v.parsed_spec||"",parsed_quantity:v.parsed_quantity||"",matched_inventory:v.matched_inventory||null,remark:"",purchase_link:""}))},M=await Ue(m),k=new Blob([M],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),F=window.URL.createObjectURL(k),_=document.createElement("a");_.href=F,_.download=`采购清单_${new Date().toISOString().slice(0,10)}.xlsx`,document.body.appendChild(_),_.click(),document.body.removeChild(_),window.URL.revokeObjectURL(F),h.success("导出成功"),z.value=!1}catch{h.error("导出失败")}finally{A.value=!1}};return xe(()=>{L()}),(a,e)=>{const m=d("el-radio-button"),M=d("el-radio-group"),k=d("el-input"),F=d("DataAnalysis"),_=d("el-icon"),v=d("el-button"),ue=d("UploadFilled"),ie=d("el-upload"),B=d("el-card"),T=d("el-col"),N=d("el-tag"),$=d("Download"),pe=d("el-empty"),P=d("el-row"),ce=d("InfoFilled"),w=d("el-form-item"),_e=d("el-date-picker"),me=d("el-slider"),fe=d("el-form"),G=d("el-dialog"),ve=d("el-progress");return p(),g("div",ze,[l(P,{gutter:20},{default:s(()=>[l(T,{span:10},{default:s(()=>[l(B,{class:"input-card"},{header:s(()=>[t("div",Se,[e[15]||(e[15]=t("span",null,"采购需求输入",-1)),l(M,{modelValue:q.value,"onUpdate:modelValue":e[0]||(e[0]=o=>q.value=o),size:"small"},{default:s(()=>[l(m,{value:"text"},{default:s(()=>[...e[13]||(e[13]=[u("文本输入",-1)])]),_:1}),l(m,{value:"file"},{default:s(()=>[...e[14]||(e[14]=[u("文件上传",-1)])]),_:1})]),_:1},8,["modelValue"])])]),default:s(()=>[q.value==="text"?(p(),g("div",Fe,[l(k,{modelValue:U.value,"onUpdate:modelValue":e[1]||(e[1]=o=>U.value=o),type:"textarea",rows:10,placeholder:`请粘贴客户的采购需求内容，例如：
1. 32寸叫号屏 2台
2. POE交换机16口 1个
3. 监控摄像头200万像素 10个`},null,8,["modelValue"]),l(v,{type:"primary",loading:f.value,disabled:!U.value.trim(),style:{"margin-top":"15px",width:"100%"},onClick:ne},{default:s(()=>[l(_,null,{default:s(()=>[l(F)]),_:1}),e[16]||(e[16]=u(" 开始智能分析 ",-1))]),_:1},8,["loading","disabled"])])):(p(),g("div",Ee,[l(ie,{ref_key:"uploadRef",ref:W,drag:"","auto-upload":!1,limit:1,"on-change":se,"on-remove":()=>D.value=null,accept:".xlsx,.xls"},{tip:s(()=>[...e[17]||(e[17]=[t("div",{class:"el-upload__tip"}," 支持 .xlsx, .xls 格式的采购需求表 ",-1)])]),default:s(()=>[l(_,{size:"48",color:"#409EFF"},{default:s(()=>[l(ue)]),_:1}),e[18]||(e[18]=t("div",{class:"el-upload__text"},[u(" 拖拽Excel文件到此处，或"),t("em",null,"点击上传")],-1))]),_:1},8,["on-remove"]),l(v,{type:"primary",loading:f.value,disabled:!D.value,style:{"margin-top":"15px",width:"100%"},onClick:ae},{default:s(()=>[l(_,null,{default:s(()=>[l(F)]),_:1}),e[19]||(e[19]=u(" 开始智能分析 ",-1))]),_:1},8,["loading","disabled"])]))]),_:1})]),_:1}),l(T,{span:14},{default:s(()=>[l(B,{class:"result-card"},{header:s(()=>{var o;return[t("div",Ie,[e[21]||(e[21]=t("span",null,"匹配结果",-1)),t("div",Le,[n.status?(p(),b(N,{key:0,type:Z.value,style:{"margin-right":"10px"}},{default:s(()=>[u(i(n.message),1)]),_:1},8,["type"])):R("",!0),(o=n.details)!=null&&o.length?(p(),b(v,{key:1,type:"success",size:"small",onClick:re},{default:s(()=>[l(_,null,{default:s(()=>[l($)]),_:1}),e[20]||(e[20]=u(" 导出Excel ",-1))]),_:1})):R("",!0)])])]}),default:s(()=>{var o;return[(o=n.details)!=null&&o.length?(p(),g("div",Te,[(p(!0),g(H,null,J(n.details,(r,ge)=>(p(),g("div",{key:r.id,class:"result-item"},[t("div",Re,[t("span",Ye,i(ge+1),1),l(N,{type:te(r.confidence_score),size:"small"},{default:s(()=>[u(" 匹配度: "+i(Math.round((r.confidence_score||0)*100))+"% ",1)]),_:2},1032,["type"])]),l(P,{gutter:15,class:"result-content"},{default:s(()=>[l(T,{span:12},{default:s(()=>[t("div",je,[e[25]||(e[25]=t("div",{class:"section-title"},"客户需求",-1)),t("div",qe,[t("p",null,[e[22]||(e[22]=t("strong",null,"产品名称:",-1)),u(" "+i(r.parsed_name||"-"),1)]),t("p",null,[e[23]||(e[23]=t("strong",null,"规格型号:",-1)),u(" "+i(r.parsed_spec||"-"),1)]),t("p",null,[e[24]||(e[24]=t("strong",null,"采购数量:",-1)),u(" "+i(r.parsed_quantity||"-"),1)])])])]),_:2},1024),l(T,{span:12},{default:s(()=>[t("div",Ae,[e[32]||(e[32]=t("div",{class:"section-title"},"匹配库存",-1)),r.matched_inventory?(p(),g("div",Me,[t("p",null,[e[26]||(e[26]=t("strong",null,"产品名称:",-1)),u(" "+i(r.matched_inventory.product_name),1)]),t("p",null,[e[27]||(e[27]=t("strong",null,"规格型号:",-1)),u(" "+i(r.matched_inventory.spec||"-"),1)]),t("p",null,[e[28]||(e[28]=t("strong",null,"库存数量:",-1)),u(" "+i(r.matched_inventory.quantity)+" "+i(r.matched_inventory.unit),1)]),t("p",null,[e[29]||(e[29]=t("strong",null,"销售单价:",-1)),u(" "+i(r.matched_inventory.sale_price||"-"),1)]),t("p",null,[e[30]||(e[30]=t("strong",null,"供应商:",-1)),u(" "+i(r.matched_inventory.supplier||"-"),1)])])):(p(),g("div",Oe,[...e[31]||(e[31]=[t("p",null,"未找到匹配的库存项",-1)])]))])]),_:2},1024)]),_:2},1024),r.match_reason?(p(),g("div",Be,[l(_,null,{default:s(()=>[l(ce)]),_:1}),u(" "+i(r.match_reason),1)])):R("",!0)]))),128))])):(p(),b(pe,{key:0,description:"暂无分析结果，请输入采购需求后点击分析"}))]}),_:1})]),_:1})]),_:1}),l(G,{modelValue:z.value,"onUpdate:modelValue":e[10]||(e[10]=o=>z.value=o),title:"导出采购清单",width:"600px"},{footer:s(()=>[l(v,{onClick:e[9]||(e[9]=o=>z.value=!1)},{default:s(()=>[...e[33]||(e[33]=[u("取消",-1)])]),_:1}),l(v,{type:"primary",loading:A.value,onClick:de},{default:s(()=>[l(_,null,{default:s(()=>[l($)]),_:1}),e[34]||(e[34]=u(" 确认导出 ",-1))]),_:1},8,["loading"])]),default:s(()=>[l(fe,{model:c,"label-width":"120px"},{default:s(()=>[l(w,{label:"客户名称缩写"},{default:s(()=>[l(k,{modelValue:c.customer_abbr,"onUpdate:modelValue":e[2]||(e[2]=o=>c.customer_abbr=o),placeholder:"请输入客户名称缩写"},null,8,["modelValue"])]),_:1}),l(w,{label:"项目/门店名称"},{default:s(()=>[l(k,{modelValue:c.project_name,"onUpdate:modelValue":e[3]||(e[3]=o=>c.project_name=o),placeholder:"请输入项目或门店名称"},null,8,["modelValue"])]),_:1}),l(w,{label:"我方开票抬头"},{default:s(()=>[l(k,{modelValue:c.invoice_title,"onUpdate:modelValue":e[4]||(e[4]=o=>c.invoice_title=o),placeholder:"请输入我方开票抬头"},null,8,["modelValue"])]),_:1}),l(w,{label:"需求发起人"},{default:s(()=>[l(k,{modelValue:c.requester,"onUpdate:modelValue":e[5]||(e[5]=o=>c.requester=o),placeholder:"请输入需求发起人"},null,8,["modelValue"])]),_:1}),l(w,{label:"采购应下单日期"},{default:s(()=>[l(_e,{modelValue:c.order_date,"onUpdate:modelValue":e[6]||(e[6]=o=>c.order_date=o),type:"date",placeholder:"选择日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",style:{width:"100%"}},null,8,["modelValue"])]),_:1}),l(w,{label:"收货地址"},{default:s(()=>[l(k,{modelValue:c.delivery_address,"onUpdate:modelValue":e[7]||(e[7]=o=>c.delivery_address=o),type:"textarea",rows:2,placeholder:"请输入收货地址"},null,8,["modelValue"])]),_:1}),l(w,{label:"最低匹配度"},{default:s(()=>{var o;return[t("div",Ne,[l(me,{modelValue:c.min_confidence,"onUpdate:modelValue":e[8]||(e[8]=r=>c.min_confidence=r),min:0,max:100,step:5,"format-tooltip":r=>r+"%",style:{flex:"1","margin-right":"15px"}},null,8,["modelValue","format-tooltip"]),t("span",$e,i(c.min_confidence)+"%",1)]),t("div",Pe," 符合条件: "+i(X.value)+" / "+i(((o=n.details)==null?void 0:o.length)||0)+" 条 ",1)]}),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),l(G,{modelValue:S.value,"onUpdate:modelValue":e[12]||(e[12]=o=>S.value=o),title:"AI智能分析中",width:"650px","close-on-click-modal":!1,"close-on-press-escape":!1,"show-close":!f.value},{footer:s(()=>[f.value?(p(),b(v,{key:1,disabled:""},{default:s(()=>[l(_,{class:"is-loading"},{default:s(()=>[l(Y(K))]),_:1}),e[38]||(e[38]=u(" 分析中... ",-1))]),_:1})):(p(),b(v,{key:0,type:"primary",onClick:e[11]||(e[11]=o=>S.value=!1)},{default:s(()=>[...e[37]||(e[37]=[u(" 确定 ",-1)])]),_:1}))]),default:s(()=>[t("div",Ge,[t("div",He,[f.value?(p(),b(_,{key:0,class:"is-loading",size:20},{default:s(()=>[l(Y(K))]),_:1})):n.status==="completed"?(p(),b(_,{key:1,size:20,color:"#67c23a"},{default:s(()=>[l(Y(ke))]),_:1})):(p(),b(_,{key:2,size:20,color:"#f56c6c"},{default:s(()=>[l(Y(be))]),_:1})),t("span",Je,i(le.value),1)]),l(ve,{percentage:x.value,status:ee.value,"stroke-width":12,style:{margin:"15px 0"}},null,8,["percentage","status"]),t("div",Ke,[t("div",Qe,[e[35]||(e[35]=t("span",null,"DeepSeek API 调用日志",-1)),t("span",We,i(V.value.length)+" 条",1)]),t("div",{class:"progress-log-content",ref_key:"logContainer",ref:E},[(p(!0),g(H,null,J(V.value,(o,r)=>(p(),g("div",{key:r,class:Ve(["log-line","log-"+o.level.toLowerCase()])},[t("span",Xe,i(o.time),1),t("span",Ze,"["+i(o.level)+"]",1),t("span",el,i(o.message),1)],2))),128)),f.value&&V.value.length===0?(p(),g("div",ll,[...e[36]||(e[36]=[t("span",{class:"log-msg"},"正在连接AI服务...",-1)])])):R("",!0)],512)])])]),_:1},8,["modelValue","show-close"])])}}},al=ye(tl,[["__scopeId","data-v-3453a82d"]]);export{al as default};
