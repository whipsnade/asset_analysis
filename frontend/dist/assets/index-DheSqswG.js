import{_ as he,y as Ve,c as g,b as l,w as s,r as d,h as y,o as i,f as u,a as t,t as a,i as b,F as X,s as Z,l as L,k as A,z as ee,A as we,B as Ce,C as Ue,E as U,g as le,D as R,G as De}from"./index-BxG9Idjn.js";import{a as ze,b as Fe,c as Se,e as Ee,d as Ie}from"./procurement-BWOpjGSg.js";const Le={class:"procurement-page"},Re={class:"card-header"},Te={key:0,class:"text-input"},Ye={key:1,class:"file-input"},je={class:"card-header"},qe={class:"header-actions"},Ae={key:1},Me={class:"filter-bar"},Oe={class:"filter-value"},Be={class:"filter-count"},Ne={class:"result-list"},$e={class:"result-header"},Pe={class:"result-index"},Ge={class:"result-section"},He={class:"section-body"},Je={class:"result-section matched"},Ke={key:0,class:"section-body"},Qe={key:1,class:"section-body no-match"},We={key:0,class:"match-reason"},Xe={style:{display:"flex","align-items":"center",width:"100%"}},Ze={style:{width:"50px","text-align":"right"}},el={class:"export-filter-info"},ll={class:"progress-content"},tl={class:"progress-status"},sl={class:"status-text"},ol={class:"progress-log-panel"},nl={class:"progress-log-header"},al={class:"log-count"},rl={class:"log-time"},dl={class:"log-level"},il={class:"log-msg"},ul={key:0,class:"log-line log-info"},pl={__name:"index",setup(cl){const M=y("text"),z=y(""),x=y([]),f=y(!1),te=y(null),F=y(!1),O=y(!1),S=y(!1),T=y(null),w=y([]),k=y(0),Y=y(0);let D=null,E=null;const n=le({task_id:null,status:"",message:"",details:[]}),c=le({customer_abbr:"",project_name:"",invoice_title:"",requester:"",order_date:"",delivery_address:"",min_confidence:0}),se=R(()=>{var e;if(!((e=n.details)!=null&&e.length))return 0;const r=c.min_confidence/100;return n.details.filter(p=>(p.confidence_score||0)>=r).length}),B=R(()=>{var e;if(!((e=n.details)!=null&&e.length))return[];const r=Y.value/100;return n.details.filter(p=>(p.confidence_score||0)>=r)}),oe=R(()=>n.status==="completed"?"success":n.status==="failed"?"danger":"info"),ne=R(()=>f.value?"":n.status==="completed"?"success":n.status==="failed"?"exception":""),ae=R(()=>{var r;return f.value?"正在使用 DeepSeek AI 分析采购需求...":n.status==="completed"?`分析完成，共匹配 ${((r=n.details)==null?void 0:r.length)||0} 条需求`:n.status==="failed"?"分析失败，请重试":"准备中..."}),re=r=>r?r>=.8?"success":r>=.5?"warning":"danger":"info",de=(r,e)=>{x.value=e.map(p=>p.raw)},ie=(r,e)=>{x.value=e.map(p=>p.raw)},ue=()=>"sess_"+Date.now()+"_"+Math.random().toString(36).substr(2,9),$=()=>{E=ue(),w.value=[];const r=Ie(E);D=new EventSource(r),D.onmessage=e=>{try{const p=JSON.parse(e.data);if(p.type==="heartbeat")return;w.value.push(p),De(()=>{T.value&&(T.value.scrollTop=T.value.scrollHeight)})}catch(p){console.error("Failed to parse log:",p)}},D.onerror=()=>{j()}},j=()=>{D&&(D.close(),D=null)},pe=async()=>{if(!z.value.trim()){U.warning("请输入采购需求内容");return}w.value=[],k.value=10,S.value=!0,f.value=!0,$();try{k.value=30;const r=await ze(z.value,E);Object.assign(n,r),k.value=100,U.success("分析完成")}catch{n.status="failed",n.message="分析失败",n.details=[],k.value=100}finally{f.value=!1,j()}},ce=async()=>{if(x.value.length===0){U.warning("请选择要上传的文件");return}w.value=[],k.value=10,S.value=!0,f.value=!0,$();try{k.value=30;const r=x.value.length===1?await Fe(x.value[0],E):await Se(x.value,E);Object.assign(n,r),k.value=100,U.success("分析完成")}catch{n.status="failed",n.message="分析失败",n.details=[],k.value=100}finally{f.value=!1,j()}},_e=()=>{F.value=!0},me=async()=>{const r=c.min_confidence/100,e=n.details.filter(p=>(p.confidence_score||0)>=r);if(e.length===0){U.warning("没有符合匹配度条件的数据可导出");return}O.value=!0;try{const p={...c,details:e.map(v=>({parsed_name:v.parsed_name||"",parsed_spec:v.parsed_spec||"",parsed_quantity:v.parsed_quantity||"",matched_inventory:v.matched_inventory||null,remark:"",purchase_link:""}))},N=await Ee(p),h=new Blob([N],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),I=window.URL.createObjectURL(h),m=document.createElement("a");m.href=I,m.download=`采购清单_${new Date().toISOString().slice(0,10)}.xlsx`,document.body.appendChild(m),m.click(),document.body.removeChild(m),window.URL.revokeObjectURL(I),U.success("导出成功"),F.value=!1}catch{U.error("导出失败")}finally{O.value=!1}};return Ve(()=>{j()}),(r,e)=>{const p=d("el-radio-button"),N=d("el-radio-group"),h=d("el-input"),I=d("DataAnalysis"),m=d("el-icon"),v=d("el-button"),fe=d("UploadFilled"),ve=d("el-upload"),P=d("el-card"),q=d("el-col"),G=d("el-tag"),H=d("Download"),J=d("el-empty"),K=d("el-slider"),Q=d("el-row"),ge=d("InfoFilled"),C=d("el-form-item"),ye=d("el-date-picker"),xe=d("el-form"),W=d("el-dialog"),ke=d("el-progress");return i(),g("div",Le,[l(Q,{gutter:20},{default:s(()=>[l(q,{span:10},{default:s(()=>[l(P,{class:"input-card"},{header:s(()=>[t("div",Re,[e[16]||(e[16]=t("span",null,"采购需求输入",-1)),l(N,{modelValue:M.value,"onUpdate:modelValue":e[0]||(e[0]=o=>M.value=o),size:"small"},{default:s(()=>[l(p,{value:"text"},{default:s(()=>[...e[14]||(e[14]=[u("文本输入",-1)])]),_:1}),l(p,{value:"file"},{default:s(()=>[...e[15]||(e[15]=[u("文件上传",-1)])]),_:1})]),_:1},8,["modelValue"])])]),default:s(()=>[M.value==="text"?(i(),g("div",Te,[l(h,{modelValue:z.value,"onUpdate:modelValue":e[1]||(e[1]=o=>z.value=o),type:"textarea",rows:10,placeholder:`请粘贴客户的采购需求内容，例如：
1. 32寸叫号屏 2台
2. POE交换机16口 1个
3. 监控摄像头200万像素 10个`},null,8,["modelValue"]),l(v,{type:"primary",loading:f.value,disabled:!z.value.trim(),style:{"margin-top":"15px",width:"100%"},onClick:pe},{default:s(()=>[l(m,null,{default:s(()=>[l(I)]),_:1}),e[17]||(e[17]=u(" 开始智能分析 ",-1))]),_:1},8,["loading","disabled"])])):(i(),g("div",Ye,[l(ve,{ref_key:"uploadRef",ref:te,drag:"",multiple:"","auto-upload":!1,"on-change":de,"on-remove":ie,accept:".xlsx,.xls"},{tip:s(()=>[...e[18]||(e[18]=[t("div",{class:"el-upload__tip"}," 支持 .xlsx, .xls 格式，可同时上传多个文件 ",-1)])]),default:s(()=>[l(m,{size:"48",color:"#409EFF"},{default:s(()=>[l(fe)]),_:1}),e[19]||(e[19]=t("div",{class:"el-upload__text"},[u(" 拖拽Excel文件到此处，或"),t("em",null,"点击上传")],-1))]),_:1},512),l(v,{type:"primary",loading:f.value,disabled:x.value.length===0,style:{"margin-top":"15px",width:"100%"},onClick:ce},{default:s(()=>[l(m,null,{default:s(()=>[l(I)]),_:1}),u(" 开始智能分析"+a(x.value.length>0?` (${x.value.length}个文件)`:""),1)]),_:1},8,["loading","disabled"])]))]),_:1})]),_:1}),l(q,{span:14},{default:s(()=>[l(P,{class:"result-card"},{header:s(()=>{var o;return[t("div",je,[e[21]||(e[21]=t("span",null,"匹配结果",-1)),t("div",qe,[n.status?(i(),b(G,{key:0,type:oe.value,style:{"margin-right":"10px"}},{default:s(()=>[u(a(n.message),1)]),_:1},8,["type"])):L("",!0),(o=n.details)!=null&&o.length?(i(),b(v,{key:1,type:"success",size:"small",onClick:_e},{default:s(()=>[l(m,null,{default:s(()=>[l(H)]),_:1}),e[20]||(e[20]=u(" 导出Excel ",-1))]),_:1})):L("",!0)])])]}),default:s(()=>{var o,V;return[(o=n.details)!=null&&o.length?(i(),g("div",Ae,[t("div",Me,[e[22]||(e[22]=t("span",{class:"filter-label"},"匹配度筛选:",-1)),l(K,{modelValue:Y.value,"onUpdate:modelValue":e[2]||(e[2]=_=>Y.value=_),min:0,max:100,step:5,"format-tooltip":_=>_+"%",class:"filter-slider"},null,8,["modelValue","format-tooltip"]),t("span",Oe,"≥ "+a(Y.value)+"%",1),t("span",Be," 显示 "+a(B.value.length)+" / "+a(((V=n.details)==null?void 0:V.length)||0)+" 条 ",1)]),t("div",Ne,[(i(!0),g(X,null,Z(B.value,(_,be)=>(i(),g("div",{key:_.id,class:"result-item"},[t("div",$e,[t("span",Pe,a(be+1),1),l(G,{type:re(_.confidence_score),size:"small"},{default:s(()=>[u(" 匹配度: "+a(Math.round((_.confidence_score||0)*100))+"% ",1)]),_:2},1032,["type"])]),l(Q,{gutter:15,class:"result-content"},{default:s(()=>[l(q,{span:12},{default:s(()=>[t("div",Ge,[e[26]||(e[26]=t("div",{class:"section-title"},"客户需求",-1)),t("div",He,[t("p",null,[e[23]||(e[23]=t("strong",null,"产品名称:",-1)),u(" "+a(_.parsed_name||"-"),1)]),t("p",null,[e[24]||(e[24]=t("strong",null,"规格型号:",-1)),u(" "+a(_.parsed_spec||"-"),1)]),t("p",null,[e[25]||(e[25]=t("strong",null,"采购数量:",-1)),u(" "+a(_.parsed_quantity||"-"),1)])])])]),_:2},1024),l(q,{span:12},{default:s(()=>[t("div",Je,[e[33]||(e[33]=t("div",{class:"section-title"},"匹配库存",-1)),_.matched_inventory?(i(),g("div",Ke,[t("p",null,[e[27]||(e[27]=t("strong",null,"产品名称:",-1)),u(" "+a(_.matched_inventory.product_name),1)]),t("p",null,[e[28]||(e[28]=t("strong",null,"规格型号:",-1)),u(" "+a(_.matched_inventory.spec||"-"),1)]),t("p",null,[e[29]||(e[29]=t("strong",null,"库存数量:",-1)),u(" "+a(_.matched_inventory.quantity)+" "+a(_.matched_inventory.unit),1)]),t("p",null,[e[30]||(e[30]=t("strong",null,"销售单价:",-1)),u(" "+a(_.matched_inventory.sale_price||"-"),1)]),t("p",null,[e[31]||(e[31]=t("strong",null,"供应商:",-1)),u(" "+a(_.matched_inventory.supplier||"-"),1)])])):(i(),g("div",Qe,[...e[32]||(e[32]=[t("p",null,"未找到匹配的库存项",-1)])]))])]),_:2},1024)]),_:2},1024),_.match_reason?(i(),g("div",We,[l(m,null,{default:s(()=>[l(ge)]),_:1}),u(" "+a(_.match_reason),1)])):L("",!0)]))),128)),B.value.length===0?(i(),b(J,{key:0,description:"当前筛选条件下无匹配结果，请降低匹配度阈值"})):L("",!0)])])):(i(),b(J,{key:0,description:"暂无分析结果，请输入采购需求后点击分析"}))]}),_:1})]),_:1})]),_:1}),l(W,{modelValue:F.value,"onUpdate:modelValue":e[11]||(e[11]=o=>F.value=o),title:"导出采购清单",width:"600px"},{footer:s(()=>[l(v,{onClick:e[10]||(e[10]=o=>F.value=!1)},{default:s(()=>[...e[34]||(e[34]=[u("取消",-1)])]),_:1}),l(v,{type:"primary",loading:O.value,onClick:me},{default:s(()=>[l(m,null,{default:s(()=>[l(H)]),_:1}),e[35]||(e[35]=u(" 确认导出 ",-1))]),_:1},8,["loading"])]),default:s(()=>[l(xe,{model:c,"label-width":"120px"},{default:s(()=>[l(C,{label:"客户名称缩写"},{default:s(()=>[l(h,{modelValue:c.customer_abbr,"onUpdate:modelValue":e[3]||(e[3]=o=>c.customer_abbr=o),placeholder:"请输入客户名称缩写"},null,8,["modelValue"])]),_:1}),l(C,{label:"项目/门店名称"},{default:s(()=>[l(h,{modelValue:c.project_name,"onUpdate:modelValue":e[4]||(e[4]=o=>c.project_name=o),placeholder:"请输入项目或门店名称"},null,8,["modelValue"])]),_:1}),l(C,{label:"我方开票抬头"},{default:s(()=>[l(h,{modelValue:c.invoice_title,"onUpdate:modelValue":e[5]||(e[5]=o=>c.invoice_title=o),placeholder:"请输入我方开票抬头"},null,8,["modelValue"])]),_:1}),l(C,{label:"需求发起人"},{default:s(()=>[l(h,{modelValue:c.requester,"onUpdate:modelValue":e[6]||(e[6]=o=>c.requester=o),placeholder:"请输入需求发起人"},null,8,["modelValue"])]),_:1}),l(C,{label:"采购应下单日期"},{default:s(()=>[l(ye,{modelValue:c.order_date,"onUpdate:modelValue":e[7]||(e[7]=o=>c.order_date=o),type:"date",placeholder:"选择日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",style:{width:"100%"}},null,8,["modelValue"])]),_:1}),l(C,{label:"收货地址"},{default:s(()=>[l(h,{modelValue:c.delivery_address,"onUpdate:modelValue":e[8]||(e[8]=o=>c.delivery_address=o),type:"textarea",rows:2,placeholder:"请输入收货地址"},null,8,["modelValue"])]),_:1}),l(C,{label:"最低匹配度"},{default:s(()=>{var o;return[t("div",Xe,[l(K,{modelValue:c.min_confidence,"onUpdate:modelValue":e[9]||(e[9]=V=>c.min_confidence=V),min:0,max:100,step:5,"format-tooltip":V=>V+"%",style:{flex:"1","margin-right":"15px"}},null,8,["modelValue","format-tooltip"]),t("span",Ze,a(c.min_confidence)+"%",1)]),t("div",el," 符合条件: "+a(se.value)+" / "+a(((o=n.details)==null?void 0:o.length)||0)+" 条 ",1)]}),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),l(W,{modelValue:S.value,"onUpdate:modelValue":e[13]||(e[13]=o=>S.value=o),title:"AI智能分析中",width:"650px","close-on-click-modal":!1,"close-on-press-escape":!1,"show-close":!f.value},{footer:s(()=>[f.value?(i(),b(v,{key:1,disabled:""},{default:s(()=>[l(m,{class:"is-loading"},{default:s(()=>[l(A(ee))]),_:1}),e[39]||(e[39]=u(" 分析中... ",-1))]),_:1})):(i(),b(v,{key:0,type:"primary",onClick:e[12]||(e[12]=o=>S.value=!1)},{default:s(()=>[...e[38]||(e[38]=[u(" 确定 ",-1)])]),_:1}))]),default:s(()=>[t("div",ll,[t("div",tl,[f.value?(i(),b(m,{key:0,class:"is-loading",size:20},{default:s(()=>[l(A(ee))]),_:1})):n.status==="completed"?(i(),b(m,{key:1,size:20,color:"#67c23a"},{default:s(()=>[l(A(we))]),_:1})):(i(),b(m,{key:2,size:20,color:"#f56c6c"},{default:s(()=>[l(A(Ce))]),_:1})),t("span",sl,a(ae.value),1)]),l(ke,{percentage:k.value,status:ne.value,"stroke-width":12,style:{margin:"15px 0"}},null,8,["percentage","status"]),t("div",ol,[t("div",nl,[e[36]||(e[36]=t("span",null,"DeepSeek API 调用日志",-1)),t("span",al,a(w.value.length)+" 条",1)]),t("div",{class:"progress-log-content",ref_key:"logContainer",ref:T},[(i(!0),g(X,null,Z(w.value,(o,V)=>(i(),g("div",{key:V,class:Ue(["log-line","log-"+o.level.toLowerCase()])},[t("span",rl,a(o.time),1),t("span",dl,"["+a(o.level)+"]",1),t("span",il,a(o.message),1)],2))),128)),f.value&&w.value.length===0?(i(),g("div",ul,[...e[37]||(e[37]=[t("span",{class:"log-msg"},"正在连接AI服务...",-1)])])):L("",!0)],512)])])]),_:1},8,["modelValue","show-close"])])}}},fl=he(pl,[["__scopeId","data-v-6c1f1094"]]);export{fl as default};
