import{a as ce,b as _e,e as me,c as fe}from"./procurement-uSSLDM8B.js";import{_ as ve,y as ge,c as m,b as l,w as n,r as a,h as g,o as c,f as d,a as t,F as N,s as A,z as ye,t as u,l as F,i as j,E as V,g as $,A as H,B as xe}from"./index-Bsg0fhHg.js";const be={class:"procurement-page"},Ve={class:"card-header"},ke={key:0,class:"text-input"},we={key:1,class:"file-input"},he={key:2,class:"log-panel"},Ce={class:"log-header"},Ue={class:"log-time"},De={class:"log-level"},Fe={class:"log-msg"},ze={key:0,class:"log-line log-info"},Ee={class:"card-header"},Se={class:"header-actions"},Le={key:1,class:"result-list"},Re={class:"result-header"},Te={class:"result-index"},Ye={class:"result-section"},je={class:"section-body"},qe={class:"result-section matched"},Ie={key:0,class:"section-body"},Me={key:1,class:"section-body no-match"},Oe={key:0,class:"match-reason"},Be={style:{display:"flex","align-items":"center",width:"100%"}},Ne={style:{width:"50px","text-align":"right"}},Ae={class:"export-filter-info"},$e={__name:"index",setup(He){const R=g("text"),h=g(""),C=g(null),y=g(!1),J=g(null),U=g(!1),T=g(!1),z=g(null),k=g([]);let w=null,E=null;const r=$({task_id:null,status:"",message:"",details:[]}),i=$({customer_abbr:"",project_name:"",invoice_title:"",requester:"",order_date:"",delivery_address:"",min_confidence:0}),P=H(()=>{var e;if(!((e=r.details)!=null&&e.length))return 0;const p=i.min_confidence/100;return r.details.filter(_=>(_.confidence_score||0)>=p).length}),G=H(()=>r.status==="completed"?"success":r.status==="failed"?"danger":"info"),K=p=>p?p>=.8?"success":p>=.5?"warning":"danger":"info",Q=p=>{C.value=p.raw},W=()=>"sess_"+Date.now()+"_"+Math.random().toString(36).substr(2,9),q=()=>{E=W(),k.value=[];const p=fe(E);w=new EventSource(p),w.onmessage=e=>{try{const _=JSON.parse(e.data);if(_.type==="heartbeat")return;k.value.push(_),xe(()=>{z.value&&(z.value.scrollTop=z.value.scrollHeight)})}catch(_){console.error("Failed to parse log:",_)}},w.onerror=()=>{S()}},S=()=>{w&&(w.close(),w=null)},X=()=>{k.value=[]},Z=async()=>{if(!h.value.trim()){V.warning("请输入采购需求内容");return}y.value=!0,q();try{const p=await ce(h.value,E);Object.assign(r,p),V.success("分析完成")}catch{r.status="failed",r.message="分析失败",r.details=[]}finally{y.value=!1,S()}},ee=async()=>{if(!C.value){V.warning("请选择要上传的文件");return}y.value=!0,q();try{const p=await _e(C.value,E);Object.assign(r,p),V.success("分析完成")}catch{r.status="failed",r.message="分析失败",r.details=[]}finally{y.value=!1,S()}},le=()=>{U.value=!0},te=async()=>{const p=i.min_confidence/100,e=r.details.filter(_=>(_.confidence_score||0)>=p);if(e.length===0){V.warning("没有符合匹配度条件的数据可导出");return}T.value=!0;try{const _={...i,details:e.map(v=>({parsed_name:v.parsed_name||"",parsed_spec:v.parsed_spec||"",parsed_quantity:v.parsed_quantity||"",matched_inventory:v.matched_inventory||null,remark:"",purchase_link:""}))},Y=await me(_),x=new Blob([Y],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),D=window.URL.createObjectURL(x),f=document.createElement("a");f.href=D,f.download=`采购清单_${new Date().toISOString().slice(0,10)}.xlsx`,document.body.appendChild(f),f.click(),document.body.removeChild(f),window.URL.revokeObjectURL(D),V.success("导出成功"),U.value=!1}catch{V.error("导出失败")}finally{T.value=!1}};return ge(()=>{S()}),(p,e)=>{const _=a("el-radio-button"),Y=a("el-radio-group"),x=a("el-input"),D=a("DataAnalysis"),f=a("el-icon"),v=a("el-button"),ne=a("UploadFilled"),oe=a("el-upload"),I=a("el-card"),L=a("el-col"),M=a("el-tag"),O=a("Download"),se=a("el-empty"),B=a("el-row"),ae=a("InfoFilled"),b=a("el-form-item"),de=a("el-date-picker"),re=a("el-slider"),ie=a("el-form"),ue=a("el-dialog");return c(),m("div",be,[l(B,{gutter:20},{default:n(()=>[l(L,{span:10},{default:n(()=>[l(I,{class:"input-card"},{header:n(()=>[t("div",Ve,[e[13]||(e[13]=t("span",null,"采购需求输入",-1)),l(Y,{modelValue:R.value,"onUpdate:modelValue":e[0]||(e[0]=o=>R.value=o),size:"small"},{default:n(()=>[l(_,{value:"text"},{default:n(()=>[...e[11]||(e[11]=[d("文本输入",-1)])]),_:1}),l(_,{value:"file"},{default:n(()=>[...e[12]||(e[12]=[d("文件上传",-1)])]),_:1})]),_:1},8,["modelValue"])])]),default:n(()=>[R.value==="text"?(c(),m("div",ke,[l(x,{modelValue:h.value,"onUpdate:modelValue":e[1]||(e[1]=o=>h.value=o),type:"textarea",rows:10,placeholder:`请粘贴客户的采购需求内容，例如：
1. 32寸叫号屏 2台
2. POE交换机16口 1个
3. 监控摄像头200万像素 10个`},null,8,["modelValue"]),l(v,{type:"primary",loading:y.value,disabled:!h.value.trim(),style:{"margin-top":"15px",width:"100%"},onClick:Z},{default:n(()=>[l(f,null,{default:n(()=>[l(D)]),_:1}),e[14]||(e[14]=d(" 开始智能分析 ",-1))]),_:1},8,["loading","disabled"])])):(c(),m("div",we,[l(oe,{ref_key:"uploadRef",ref:J,drag:"","auto-upload":!1,limit:1,"on-change":Q,"on-remove":()=>C.value=null,accept:".xlsx,.xls"},{tip:n(()=>[...e[15]||(e[15]=[t("div",{class:"el-upload__tip"}," 支持 .xlsx, .xls 格式的采购需求表 ",-1)])]),default:n(()=>[l(f,{size:"48",color:"#409EFF"},{default:n(()=>[l(ne)]),_:1}),e[16]||(e[16]=t("div",{class:"el-upload__text"},[d(" 拖拽Excel文件到此处，或"),t("em",null,"点击上传")],-1))]),_:1},8,["on-remove"]),l(v,{type:"primary",loading:y.value,disabled:!C.value,style:{"margin-top":"15px",width:"100%"},onClick:ee},{default:n(()=>[l(f,null,{default:n(()=>[l(D)]),_:1}),e[17]||(e[17]=d(" 开始智能分析 ",-1))]),_:1},8,["loading","disabled"])])),k.value.length>0||y.value?(c(),m("div",he,[t("div",Ce,[e[19]||(e[19]=t("span",null,"AI调用日志",-1)),l(v,{size:"small",link:"",onClick:X},{default:n(()=>[...e[18]||(e[18]=[d("清空",-1)])]),_:1})]),t("div",{class:"log-content",ref_key:"logContainer",ref:z},[(c(!0),m(N,null,A(k.value,(o,s)=>(c(),m("div",{key:s,class:ye(["log-line","log-"+o.level.toLowerCase()])},[t("span",Ue,u(o.time),1),t("span",De,"["+u(o.level)+"]",1),t("span",Fe,u(o.message),1)],2))),128)),y.value&&k.value.length===0?(c(),m("div",ze,[...e[20]||(e[20]=[t("span",{class:"log-msg"},"等待日志...",-1)])])):F("",!0)],512)])):F("",!0)]),_:1})]),_:1}),l(L,{span:14},{default:n(()=>[l(I,{class:"result-card"},{header:n(()=>{var o;return[t("div",Ee,[e[22]||(e[22]=t("span",null,"匹配结果",-1)),t("div",Se,[r.status?(c(),j(M,{key:0,type:G.value,style:{"margin-right":"10px"}},{default:n(()=>[d(u(r.message),1)]),_:1},8,["type"])):F("",!0),(o=r.details)!=null&&o.length?(c(),j(v,{key:1,type:"success",size:"small",onClick:le},{default:n(()=>[l(f,null,{default:n(()=>[l(O)]),_:1}),e[21]||(e[21]=d(" 导出Excel ",-1))]),_:1})):F("",!0)])])]}),default:n(()=>{var o;return[(o=r.details)!=null&&o.length?(c(),m("div",Le,[(c(!0),m(N,null,A(r.details,(s,pe)=>(c(),m("div",{key:s.id,class:"result-item"},[t("div",Re,[t("span",Te,u(pe+1),1),l(M,{type:K(s.confidence_score),size:"small"},{default:n(()=>[d(" 匹配度: "+u(Math.round((s.confidence_score||0)*100))+"% ",1)]),_:2},1032,["type"])]),l(B,{gutter:15,class:"result-content"},{default:n(()=>[l(L,{span:12},{default:n(()=>[t("div",Ye,[e[26]||(e[26]=t("div",{class:"section-title"},"客户需求",-1)),t("div",je,[t("p",null,[e[23]||(e[23]=t("strong",null,"产品名称:",-1)),d(" "+u(s.parsed_name||"-"),1)]),t("p",null,[e[24]||(e[24]=t("strong",null,"规格型号:",-1)),d(" "+u(s.parsed_spec||"-"),1)]),t("p",null,[e[25]||(e[25]=t("strong",null,"采购数量:",-1)),d(" "+u(s.parsed_quantity||"-"),1)])])])]),_:2},1024),l(L,{span:12},{default:n(()=>[t("div",qe,[e[33]||(e[33]=t("div",{class:"section-title"},"匹配库存",-1)),s.matched_inventory?(c(),m("div",Ie,[t("p",null,[e[27]||(e[27]=t("strong",null,"产品名称:",-1)),d(" "+u(s.matched_inventory.product_name),1)]),t("p",null,[e[28]||(e[28]=t("strong",null,"规格型号:",-1)),d(" "+u(s.matched_inventory.spec||"-"),1)]),t("p",null,[e[29]||(e[29]=t("strong",null,"库存数量:",-1)),d(" "+u(s.matched_inventory.quantity)+" "+u(s.matched_inventory.unit),1)]),t("p",null,[e[30]||(e[30]=t("strong",null,"销售单价:",-1)),d(" "+u(s.matched_inventory.sale_price||"-"),1)]),t("p",null,[e[31]||(e[31]=t("strong",null,"供应商:",-1)),d(" "+u(s.matched_inventory.supplier||"-"),1)])])):(c(),m("div",Me,[...e[32]||(e[32]=[t("p",null,"未找到匹配的库存项",-1)])]))])]),_:2},1024)]),_:2},1024),s.match_reason?(c(),m("div",Oe,[l(f,null,{default:n(()=>[l(ae)]),_:1}),d(" "+u(s.match_reason),1)])):F("",!0)]))),128))])):(c(),j(se,{key:0,description:"暂无分析结果，请输入采购需求后点击分析"}))]}),_:1})]),_:1})]),_:1}),l(ue,{modelValue:U.value,"onUpdate:modelValue":e[10]||(e[10]=o=>U.value=o),title:"导出采购清单",width:"600px"},{footer:n(()=>[l(v,{onClick:e[9]||(e[9]=o=>U.value=!1)},{default:n(()=>[...e[34]||(e[34]=[d("取消",-1)])]),_:1}),l(v,{type:"primary",loading:T.value,onClick:te},{default:n(()=>[l(f,null,{default:n(()=>[l(O)]),_:1}),e[35]||(e[35]=d(" 确认导出 ",-1))]),_:1},8,["loading"])]),default:n(()=>[l(ie,{model:i,"label-width":"120px"},{default:n(()=>[l(b,{label:"客户名称缩写"},{default:n(()=>[l(x,{modelValue:i.customer_abbr,"onUpdate:modelValue":e[2]||(e[2]=o=>i.customer_abbr=o),placeholder:"请输入客户名称缩写"},null,8,["modelValue"])]),_:1}),l(b,{label:"项目/门店名称"},{default:n(()=>[l(x,{modelValue:i.project_name,"onUpdate:modelValue":e[3]||(e[3]=o=>i.project_name=o),placeholder:"请输入项目或门店名称"},null,8,["modelValue"])]),_:1}),l(b,{label:"我方开票抬头"},{default:n(()=>[l(x,{modelValue:i.invoice_title,"onUpdate:modelValue":e[4]||(e[4]=o=>i.invoice_title=o),placeholder:"请输入我方开票抬头"},null,8,["modelValue"])]),_:1}),l(b,{label:"需求发起人"},{default:n(()=>[l(x,{modelValue:i.requester,"onUpdate:modelValue":e[5]||(e[5]=o=>i.requester=o),placeholder:"请输入需求发起人"},null,8,["modelValue"])]),_:1}),l(b,{label:"采购应下单日期"},{default:n(()=>[l(de,{modelValue:i.order_date,"onUpdate:modelValue":e[6]||(e[6]=o=>i.order_date=o),type:"date",placeholder:"选择日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",style:{width:"100%"}},null,8,["modelValue"])]),_:1}),l(b,{label:"收货地址"},{default:n(()=>[l(x,{modelValue:i.delivery_address,"onUpdate:modelValue":e[7]||(e[7]=o=>i.delivery_address=o),type:"textarea",rows:2,placeholder:"请输入收货地址"},null,8,["modelValue"])]),_:1}),l(b,{label:"最低匹配度"},{default:n(()=>{var o;return[t("div",Be,[l(re,{modelValue:i.min_confidence,"onUpdate:modelValue":e[8]||(e[8]=s=>i.min_confidence=s),min:0,max:100,step:5,"format-tooltip":s=>s+"%",style:{flex:"1","margin-right":"15px"}},null,8,["modelValue","format-tooltip"]),t("span",Ne,u(i.min_confidence)+"%",1)]),t("div",Ae," 符合条件: "+u(P.value)+" / "+u(((o=r.details)==null?void 0:o.length)||0)+" 条 ",1)]}),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}},Ge=ve($e,[["__scopeId","data-v-e89cb6f7"]]);export{Ge as default};
