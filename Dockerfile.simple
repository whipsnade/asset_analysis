# 简化版 Dockerfile - 使用预构建的前端文件
# 使用华为云镜像源

FROM swr.cn-north-4.myhuaweicloud.com/ddn-k8s/docker.io/python:3.10-slim

WORKDIR /app

# 使用阿里云apt源
RUN sed -i 's/deb.debian.org/mirrors.aliyun.com/g' /etc/apt/sources.list.d/debian.sources 2>/dev/null || true

# Copy requirements and install Python dependencies (use pre-compiled wheels)
COPY backend/requirements.txt ./
RUN pip install --no-cache-dir -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple

# Copy backend source
COPY backend/app ./app

# Copy pre-built frontend (run 'cd frontend && npm run build' first)
COPY frontend/dist ./static

# Expose port
EXPOSE 80

# Environment variables (override at runtime with -e)
ENV DATABASE_URL="mysql+pymysql://income:Vk7#a3DfGtYhJkL9@118.195.236.243:53890/income"
ENV DEEPSEEK_API_KEY="sk-0d58e31989a2447daec86f84d4f11dec"
ENV DEEPSEEK_API_URL="https://api.deepseek.com/v1"

# Run application
CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "80"]
